{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ayush/Desktop/Main%20EL%203rd%20sem/cpcb-dashboard/src/app/api/predict/route.ts"],"sourcesContent":["// app/api/predict/route.ts\r\n// Real-time AI violation prediction using trained model\r\n\r\nimport { NextResponse } from 'next/server';\r\nimport { exec } from 'child_process';\r\nimport { promisify } from 'util';\r\nimport path from 'path';\r\n\r\nconst execAsync = promisify(exec);\r\n\r\n// Fallback prediction function (rule-based)\r\nfunction fallbackPrediction(sensorData: any) {\r\n    const violations: string[] = [];\r\n    let violationScore = 0;\r\n\r\n    // Check thresholds\r\n    if (sensorData.turbidity_ntu > 200) {\r\n        violations.push('turbidity_high');\r\n        violationScore += 0.3;\r\n    }\r\n\r\n    if (sensorData.ph < 5.5) {\r\n        violations.push('ph_low');\r\n        violationScore += 0.3;\r\n    } else if (sensorData.ph > 9.0) {\r\n        violations.push('ph_high');\r\n        violationScore += 0.3;\r\n    }\r\n\r\n    if (sensorData.chromium_mg_l > 0.1) {\r\n        violations.push('chromium_high');\r\n        violationScore += 0.4;\r\n    }\r\n\r\n    if (sensorData.copper_mg_l > 3.0) {\r\n        violations.push('copper_high');\r\n        violationScore += 0.3;\r\n    }\r\n\r\n    if (sensorData.tds_mg_l > 2100) {\r\n        violations.push('tds_high');\r\n        violationScore += 0.2;\r\n    }\r\n\r\n    if (sensorData.uv_vis_absorbance && sensorData.uv_vis_absorbance > 1.0) {\r\n        violations.push('uv_absorbance_high');\r\n        violationScore += 0.2;\r\n    }\r\n\r\n    const isViolation = violations.length > 0;\r\n    const probability = Math.min(violationScore, 1.0);\r\n\r\n    let alertLevel: string;\r\n    if (probability >= 0.8) alertLevel = 'critical';\r\n    else if (probability >= 0.6) alertLevel = 'high';\r\n    else if (probability >= 0.3) alertLevel = 'medium';\r\n    else alertLevel = 'low';\r\n\r\n    return {\r\n        is_violation: isViolation,\r\n        violation_probability: probability,\r\n        confidence: 0.85,\r\n        violation_reasons: violations,\r\n        alert_level: alertLevel,\r\n        factory_id: sensorData.factory_id,\r\n        timestamp: new Date().toISOString(),\r\n    };\r\n}\r\n\r\nexport async function POST(request: Request) {\r\n    try {\r\n        const sensorData = await request.json();\r\n\r\n        // Validate required fields\r\n        const required = ['factory_id', 'factory_type', 'turbidity_ntu', 'ph', 'chromium_mg_l'];\r\n        for (const field of required) {\r\n            if (sensorData[field] === undefined) {\r\n                return NextResponse.json(\r\n                    { success: false, error: `Missing required field: ${field}` },\r\n                    { status: 400 }\r\n                );\r\n            }\r\n        }\r\n\r\n        // Try Python prediction first\r\n        try {\r\n            const pythonScript = path.join(process.cwd(), '..', 'predict_pollution.py');\r\n            const dataJson = JSON.stringify(sensorData);\r\n\r\n            const { stdout, stderr } = await execAsync(\r\n                `python \"${pythonScript}\" --predict '${dataJson.replace(/'/g, \"\\\\'\")}'`,\r\n                {\r\n                    cwd: path.dirname(pythonScript),\r\n                    timeout: 5000 // 5 second timeout\r\n                }\r\n            );\r\n\r\n            if (stderr && !stderr.includes('FutureWarning') && !stderr.includes('DeprecationWarning')) {\r\n                console.warn('Python stderr:', stderr);\r\n            }\r\n\r\n            const prediction = JSON.parse(stdout.trim());\r\n\r\n            return NextResponse.json({\r\n                success: true,\r\n                prediction: {\r\n                    is_violation: prediction.is_violation,\r\n                    violation_probability: prediction.violation_probability,\r\n                    confidence: prediction.confidence,\r\n                    violation_reasons: prediction.violation_reasons,\r\n                    alert_level: prediction.alert_level,\r\n                    factory_id: sensorData.factory_id,\r\n                    timestamp: new Date().toISOString(),\r\n                },\r\n                source: 'python_ml_model'\r\n            });\r\n        } catch (pythonError: any) {\r\n            console.warn('Python prediction failed, using fallback:', pythonError.message);\r\n\r\n            // Use fallback prediction\r\n            const prediction = fallbackPrediction(sensorData);\r\n\r\n            return NextResponse.json({\r\n                success: true,\r\n                prediction,\r\n                source: 'fallback_rules',\r\n                note: 'Using rule-based prediction (Python model unavailable)'\r\n            });\r\n        }\r\n    } catch (error: any) {\r\n        console.error('Prediction error:', error);\r\n        return NextResponse.json(\r\n            {\r\n                success: false,\r\n                error: 'Prediction failed',\r\n                details: error.message,\r\n            },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA,2BAA2B;AAC3B,wDAAwD;AAExD;AACA;AACA;AACA;;;;;AAEA,MAAM,YAAY,IAAA,8GAAS,EAAC,2HAAI;AAEhC,4CAA4C;AAC5C,SAAS,mBAAmB,UAAe;IACvC,MAAM,aAAuB,EAAE;IAC/B,IAAI,iBAAiB;IAErB,mBAAmB;IACnB,IAAI,WAAW,aAAa,GAAG,KAAK;QAChC,WAAW,IAAI,CAAC;QAChB,kBAAkB;IACtB;IAEA,IAAI,WAAW,EAAE,GAAG,KAAK;QACrB,WAAW,IAAI,CAAC;QAChB,kBAAkB;IACtB,OAAO,IAAI,WAAW,EAAE,GAAG,KAAK;QAC5B,WAAW,IAAI,CAAC;QAChB,kBAAkB;IACtB;IAEA,IAAI,WAAW,aAAa,GAAG,KAAK;QAChC,WAAW,IAAI,CAAC;QAChB,kBAAkB;IACtB;IAEA,IAAI,WAAW,WAAW,GAAG,KAAK;QAC9B,WAAW,IAAI,CAAC;QAChB,kBAAkB;IACtB;IAEA,IAAI,WAAW,QAAQ,GAAG,MAAM;QAC5B,WAAW,IAAI,CAAC;QAChB,kBAAkB;IACtB;IAEA,IAAI,WAAW,iBAAiB,IAAI,WAAW,iBAAiB,GAAG,KAAK;QACpE,WAAW,IAAI,CAAC;QAChB,kBAAkB;IACtB;IAEA,MAAM,cAAc,WAAW,MAAM,GAAG;IACxC,MAAM,cAAc,KAAK,GAAG,CAAC,gBAAgB;IAE7C,IAAI;IACJ,IAAI,eAAe,KAAK,aAAa;SAChC,IAAI,eAAe,KAAK,aAAa;SACrC,IAAI,eAAe,KAAK,aAAa;SACrC,aAAa;IAElB,OAAO;QACH,cAAc;QACd,uBAAuB;QACvB,YAAY;QACZ,mBAAmB;QACnB,aAAa;QACb,YAAY,WAAW,UAAU;QACjC,WAAW,IAAI,OAAO,WAAW;IACrC;AACJ;AAEO,eAAe,KAAK,OAAgB;IACvC,IAAI;QACA,MAAM,aAAa,MAAM,QAAQ,IAAI;QAErC,2BAA2B;QAC3B,MAAM,WAAW;YAAC;YAAc;YAAgB;YAAiB;YAAM;SAAgB;QACvF,KAAK,MAAM,SAAS,SAAU;YAC1B,IAAI,UAAU,CAAC,MAAM,KAAK,WAAW;gBACjC,OAAO,qKAAY,CAAC,IAAI,CACpB;oBAAE,SAAS;oBAAO,OAAO,CAAC,wBAAwB,EAAE,OAAO;gBAAC,GAC5D;oBAAE,QAAQ;gBAAI;YAEtB;QACJ;QAEA,8BAA8B;QAC9B,IAAI;YACA,MAAM,eAAe,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,MAAM;YACpD,MAAM,WAAW,KAAK,SAAS,CAAC;YAEhC,MAAM,EAAE,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,UAC7B,CAAC,QAAQ,EAAE,aAAa,aAAa,EAAE,SAAS,OAAO,CAAC,MAAM,OAAO,CAAC,CAAC,EACvE;gBACI,KAAK,4GAAI,CAAC,OAAO,CAAC;gBAClB,SAAS,KAAK,mBAAmB;YACrC;YAGJ,IAAI,UAAU,CAAC,OAAO,QAAQ,CAAC,oBAAoB,CAAC,OAAO,QAAQ,CAAC,uBAAuB;gBACvF,QAAQ,IAAI,CAAC,kBAAkB;YACnC;YAEA,MAAM,aAAa,KAAK,KAAK,CAAC,OAAO,IAAI;YAEzC,OAAO,qKAAY,CAAC,IAAI,CAAC;gBACrB,SAAS;gBACT,YAAY;oBACR,cAAc,WAAW,YAAY;oBACrC,uBAAuB,WAAW,qBAAqB;oBACvD,YAAY,WAAW,UAAU;oBACjC,mBAAmB,WAAW,iBAAiB;oBAC/C,aAAa,WAAW,WAAW;oBACnC,YAAY,WAAW,UAAU;oBACjC,WAAW,IAAI,OAAO,WAAW;gBACrC;gBACA,QAAQ;YACZ;QACJ,EAAE,OAAO,aAAkB;YACvB,QAAQ,IAAI,CAAC,6CAA6C,YAAY,OAAO;YAE7E,0BAA0B;YAC1B,MAAM,aAAa,mBAAmB;YAEtC,OAAO,qKAAY,CAAC,IAAI,CAAC;gBACrB,SAAS;gBACT;gBACA,QAAQ;gBACR,MAAM;YACV;QACJ;IACJ,EAAE,OAAO,OAAY;QACjB,QAAQ,KAAK,CAAC,qBAAqB;QACnC,OAAO,qKAAY,CAAC,IAAI,CACpB;YACI,SAAS;YACT,OAAO;YACP,SAAS,MAAM,OAAO;QAC1B,GACA;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}